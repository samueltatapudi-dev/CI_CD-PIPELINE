version: '3.8'

services:
  jenkins:
    build:
      context: ./jenkins
      dockerfile: Dockerfile
    container_name: jenkins
    user: root
    ports:
      - "8081:8080"
      - "50001:50000"
    environment:
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false
      - CASC_JENKINS_CONFIG=/usr/share/jenkins/ref/casc/jenkins.yaml
      - JENKINS_ADMIN_ID=${JENKINS_ADMIN_ID:-admin}
      - JENKINS_ADMIN_PASSWORD=${JENKINS_ADMIN_PASSWORD:-admin123}
      - APP_REPO_URL=${APP_REPO_URL:-https://github.com/samueltatapudi-dev/CI_CD_APP_VERSION}
      - APP_REPO_BRANCH=${APP_REPO_BRANCH:-main}
      - DOCKERHUB_USERNAME=${DOCKERHUB_USERNAME:-changeme}
      - DOCKERHUB_TOKEN=${DOCKERHUB_TOKEN:-changeme}
      - SONARQUBE_TOKEN=${SONARQUBE_TOKEN:-changeme}
      - IMAGE_REPO=${IMAGE_REPO:-your-dockerhub-namespace/ci-cd-app}
      - KUBE_NAMESPACE=${KUBE_NAMESPACE:-default}
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount local kube and minikube configs for kubectl access
      - ${USERPROFILE}/.kube:/root/.kube
      - ${USERPROFILE}/.minikube:/root/.minikube
      # Mount Kubernetes manifests for deployments
      - ./k8s:/opt/cicd/k8s:ro
    depends_on:
      - sonarqube-ci

  sonarqube-ci:
    image: sonarqube:10.3-community
    container_name: sonarqube-ci
    depends_on:
      - sonardb
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://sonardb:5432/sonarqube
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=sonar
    ports:
      - "9001:9000"
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs

  sonardb:
    image: postgres:15
    container_name: sonardb
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
      - POSTGRES_DB=sonarqube
    volumes:
      - sonardb_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

volumes:
  jenkins_home:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  sonardb_data:
